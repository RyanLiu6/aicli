name: Test Setup Script

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-setup:
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, ubuntu-latest]
    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Run setup script
      run: |
        python scripts/setup.py

    - name: Verify Claude Code configuration
      run: |
        echo "Checking Claude Code configuration..."

        if [ -d ~/.claude ]; then
            echo "✓ ~/.claude directory exists"
        else
            echo "✗ ~/.claude directory missing"
            exit 1
        fi

        if [ -L ~/.claude/CLAUDE.md ]; then
            echo "✓ ~/.claude/CLAUDE.md symlink exists"
        else
            echo "✗ ~/.claude/CLAUDE.md symlink missing"
            exit 1
        fi

        # Note: settings.json is user-created from settings.template.json, not checked in CI

        if [ -d ~/.claude/skills ]; then
            echo "✓ ~/.claude/skills directory exists"
            ls -la ~/.claude/skills/
        else
            echo "✗ ~/.claude/skills directory missing"
            exit 1
        fi

    - name: Verify Gemini CLI configuration
      run: |
        echo "Checking Gemini CLI configuration..."

        if [ -d ~/.gemini ]; then
            echo "✓ ~/.gemini directory exists"
        else
            echo "✗ ~/.gemini directory missing"
            exit 1
        fi

        if [ -L ~/.gemini/GEMINI.md ]; then
            echo "✓ ~/.gemini/GEMINI.md symlink exists"
        else
            echo "✗ ~/.gemini/GEMINI.md symlink missing"
            exit 1
        fi

        if [ -L ~/.gemini/settings.json ]; then
            echo "✓ ~/.gemini/settings.json symlink exists"
        else
            echo "✗ ~/.gemini/settings.json symlink missing"
            exit 1
        fi

        # Gemini commands are generated (not symlinked) as TOML files
        if [ -d ~/.gemini/commands ]; then
            echo "✓ ~/.gemini/commands directory exists"
            ls -la ~/.gemini/commands/
            # Verify TOML files were generated
            if [ -f ~/.gemini/commands/create-pr.toml ]; then
                echo "✓ TOML files generated correctly"
            else
                echo "✗ TOML files not generated"
                exit 1
            fi
        else
            echo "✗ ~/.gemini/commands directory missing"
            exit 1
        fi

    - name: Verify OpenCode configuration
      run: |
        echo "Checking OpenCode configuration..."

        if [ -d ~/.config/opencode ]; then
            echo "✓ ~/.config/opencode directory exists"
        else
            echo "✗ ~/.config/opencode directory missing"
            exit 1
        fi

        if [ -L ~/.config/opencode/AGENTS.md ]; then
            echo "✓ ~/.config/opencode/AGENTS.md symlink exists"
        else
            echo "✗ ~/.config/opencode/AGENTS.md symlink missing"
            exit 1
        fi

        if [ -L ~/.config/opencode/opencode.json ]; then
            echo "✓ ~/.config/opencode/opencode.json symlink exists"
        else
            echo "✗ ~/.config/opencode/opencode.json symlink missing"
            exit 1
        fi

        if [ -d ~/.config/opencode/command ]; then
            echo "✓ ~/.config/opencode/command directory exists"
            ls -la ~/.config/opencode/command/
        else
            echo "✗ ~/.config/opencode/command directory missing"
            exit 1
        fi

    - name: Test idempotency
      run: |
        echo "Testing that setup can be run multiple times..."
        python scripts/setup.py
        echo "✓ Setup script is idempotent"
